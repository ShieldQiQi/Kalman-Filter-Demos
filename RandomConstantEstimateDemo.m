% this demo is a practice of the example in paper "An introduction to the kalman filter-2001"
% date: 2021-03-19
% Author: XiaoFangQi
%%
% 定义预测噪声协方差和测量噪声协方差
Q = 10^(-5);
R = 0.01;

% 定义初始最优预测值和最优预测的误差协方差(初始值不能为0)，起始的测量值
X0 = 0;
P0 = 1;
Z = -0.37727;

% 模拟出56个以0为中心分布的标准偏差为0.1(鉴于R协方差为0.01)的不同的测量值，提前模拟测量值用于后面调整参数时使用同一组数据便于对比
% 使用函数normrnd(-0.37727,0.1,[1,56])生成
Zk = [-0.159492129081585,-0.263423461267040,-0.626958650318450,-0.333137306827239,-0.517083787581107,-0.402775517988081,-0.360829592668127,-0.302496597119188,-0.404574694940291,-0.219639985345392,-0.425363715177885,-0.344518787917031,-0.310796587937241,-0.368751140727884,-0.289174721461895,-0.344948686215240,-0.455684618366409,-0.557807335138609,-0.191410705144429,-0.437723008877446,-0.366934027768935,-0.320953304485402,-0.365910300326600,-0.467742621279803,-0.424041458245186,-0.389758994722311,-0.229374150849597,-0.463351569000696,-0.298803153271218,-0.346407686005147,-0.400656004212915,-0.482967274596013,-0.405684095462616,-0.385939028245931,-0.524209507448636,-0.358051775512921,-0.459499327629018,-0.386694058795972,-0.343648665904576,-0.467735405924684,-0.406095636120570,-0.342263724246582,-0.560855914250431,-0.273672409175452,-0.134823885506064,-0.281329949059202,-0.408847199500941,-0.334407732014060,-0.480868477851339,-0.189483453950414,-0.283199559664787,-0.298535422006475,-0.464857426195667,-0.345275086561767,-0.433099428485090,-0.408412941854689];
Zk(1)=Z;
X(1:56)=0; % 最优估测值
P(1:56)=0; % 最优预测误差协方差
P_(1:56)=0;% 预测误差协方差
K(1:56)=0; % 卡尔曼权重系数
%%
% 开始模拟kalman filter时间更新和测量更新一组循环，迭代
P_(1) = P0+Q;
K(1) = P_(1)/(P_(1)+R);
X(1) = (1-K(1))*X0+K(1)*Zk(1);
P(1) = (1-K(1))*P_(1);
for k = 2:1:56
    P_(k) = P(k-1)+Q;
    K(k) = P_(k)/(P_(k)+R);
    X(k) = (1-K(k))*X(k-1)+K(k)*Zk(k);
    P(k) = (1-K(k))*P_(k);
end
%%
% plot the curve
figure(1);
plot((1:56),X,'k','LineWidth',1.2);
hold on;
Zc(1:56)=Z;
plot((1:56),Zc,'k','LineWidth',1);
hold on;
scatter((1:56),Zk,'x','k','LineWidth',0.8);
title('the KF result');

figure(2);
plot((1:56),P,'k','LineWidth',1);
title('the posteriori estimate error covariance');
